{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card mb-4">
      {% if tour.image %}
        <img src="{{ tour.image.url }}" class="card-img-top">
      {% else %}
        <img src="/static/img/placeholder.jpg" class="card-img-top">
      {% endif %}
      <div class="card-body">
        <h2 class="mb-1">{{ tour.title }} {% if tour.is_promotion %}<span class="badge-prom">Promo {{ tour.discount_percent }}%</span>{% endif %}</h2>
        <p class="text-muted">{{ tour.destination.name }}</p>
        <p>{{ tour.description|linebreaks }}</p>
      </div>
    </div>
    <div class="card p-3 mb-4">
      <h5>Highlights</h5>
      <div class="row g-3">
        <div class="col-6">
          <div class="p-3 bg-light rounded">Included: transportation, visits, activities (see description)</div>
        </div>
        <div class="col-6">
          <div class="p-3 bg-light rounded">Duration: variable</div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card p-3 sticky-top">
      <h5>Booking</h5>
      <p class="mb-1">Price per person / night:</p>
      <p class="fs-5">
        <strong id="display-base">{{ tour.price_per_night|default:1000 }} MAD</strong>
      </p>
      <form action="{% url 'book_tour' tour.id %}" method="post">
        {% csrf_token %}
        <input type="hidden" id="base-price" value="{{ tour.price_per_night|default:1000 }}">
        <label>Nights</label>
        <input type="number" name="nights" value="1" min="1" class="form-control mb-2">
        <label>Persons</label>
        <input type="number" name="persons" value="1" min="1" class="form-control mb-2">
        <p>Group discount: <small>10% for 5+ persons</small></p>
        <p>Total: <strong id="live-price">0 MAD</strong></p>
        <button class="btn btn-primary w-100">Confirm booking</button>
      </form>
    </div>
  </div>
</div>

<script>
  // initialize live price
  (function(){
    const base = parseFloat(document.getElementById('base-price').value || 1000);
    const nights = document.querySelector('input[name="nights"]');
    const persons = document.querySelector('input[name="persons"]');
    const live = document.getElementById('live-price');
    const displayBase = document.getElementById('display-base');
    function update(){
      const n = parseInt(nights.value||1);
      const p = parseInt(persons.value||1);
      let total = base * n * p;
      // group discount 10% for 5 or more persons
      if(p >= 5){ total = total * 0.9; }
      live.textContent = total.toFixed(2) + ' MAD';
    }
    nights.addEventListener('input', update);
    persons.addEventListener('input', update);
    displayBase.textContent = base + ' MAD';
    update();
  })();
</script>

{% endblock %}
